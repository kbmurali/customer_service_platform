# ── API Gateway — mTLS reverse proxy ─────────────────────────────────────

# Use Docker's internal DNS resolver (127.0.0.11) for dynamic upstream resolution.
# This defers hostname lookup to request time rather than startup,
# so Nginx starts even if upstream services aren't running yet.
resolver 127.0.0.11 valid=10s ipv6=off;

server {
    listen 8443 ssl;
    server_name api-gateway;

    # ── Server certificate (Swarm secret, auto-mounted at /run/secrets/) ──
    ssl_certificate     /run/secrets/MCP_SERVER_CERT;
    ssl_certificate_key /run/secrets/MCP_SERVER_KEY;

    # ── mTLS: require and verify client certificate ──
    ssl_client_certificate /run/secrets/MCP_CA_CERT;
    ssl_verify_client      on;

    # ── TLS hardening ──
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;

    # ── Member Services MCP tools ──
    location /member-services/ {
        # Variable forces Nginx to use the resolver at request time
        set $upstream_member http://member-services-mcp-tools:8001;
        # Rewrite strips the /member-services prefix before proxying
        rewrite ^/member-services/(.*)$ /$1 break;
        proxy_pass         $upstream_member;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Client-DN       $ssl_client_s_dn;
        proxy_read_timeout  120s;
        proxy_send_timeout  120s;
        proxy_connect_timeout 10s;
    }

    # ── Future: Claims Services MCP tools ──
    # location /claims-services/ {
    #     set $upstream_claims http://claims-services-mcp-tools:8002;
    #     proxy_pass $upstream_claims/;
    # }

    # ── Future: PA Services MCP tools ──
    # location /pa-services/ {
    #     set $upstream_pa http://pa-services-mcp-tools:8003;
    #     proxy_pass $upstream_pa/;
    # }

    # ── Future: Provider Services MCP tools ──
    # location /provider-services/ {
    #     set $upstream_provider http://provider-services-mcp-tools:8004;
    #     proxy_pass $upstream_provider/;
    # }

    # ── Future: Supervisor A2A endpoints ──
    # location /supervisor/member/ {
    #     set $upstream_sup_member http://member-supervisor:9001;
    #     proxy_pass $upstream_sup_member/;
    # }
}

# ── Plain HTTP server for internal Swarm healthcheck only ──
server {
    listen 8080;
    server_name localhost;

    location /nginx-health {
        access_log off;
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }

    location / {
        return 444;
    }
}